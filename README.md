# FastSal

FastSal is a fast saliency map predictor base on MobielNet V2 backbone. FastSal (A) achieves near real time speed 
on CPU (>30FPS). There are 2 versions of FastSal A(ddition) and C(oncatenetion) which can be chosen by specifying 
-model_type. 2 pretrained weights from Salicon 2017 and coco 2019 detection task are provided. 2 fintuned 

## Install Dependencies

Use the package manager [pip](https://pip.pypa.io/en/stable/) to install python library dependencies.

```bash
pip install -r requirements.txt
```

## Usage

#### Download pretrained teacher models and/or weights 
SALGAN teacher's weights can be downloaded from [here](https://drive.google.com/file/d/1Wjf20lt8t-AWtwYbBVnaXW7wakVMuQIU/view?usp=sharing).

DeepGaze II computational graph can be downloaded from [here](https://deepgaze.bethgelab.org)

#### Pretrain
SALGAN teacher's weights is needed for pretrain.

Supports salicon or coco for -dataset_name.
Supports A or C for -model_type

Pretrain with SALICON 2017
```bash
python pretrain.py \
-batch_size 30 \
-dataset_name salicon \
-dataset_path DATASET_PATH \
-teacher_path SALGAN_PATH \
-save_dir checkpoint \
-model_name pretrained_salicon
```
Pretrain with COCO
```bash
python pretrain.py \
-batch_size 30 \
-dataset_name coco \
-dataset_path DATASET_PATH \
-teacher_path SALGAN_PATH \
-save_dir checkpoint \
-model_name pretrained_coco
```

#### Finetune
SALGAN teacher's weights is needed for fine tuning.
Finetune can be either from pretrained weights or random initialized weights. If -pretrain_path is not provided
then random intialized weights are used.

Supports salicon or coco for -dataset_name. If -dataset_name is coco, -pseudo_path needs to be specified.
Supports A or C for -model_type

Finetune FastSal A with SALGAN teacher and pretrained weights using SALICON 2017
```bash
python fine_tune.py \
-model_type A \
-batch_size 30 \
-dataset_name salicon \
-dataset_path DATASET_PATH \
-teacher_path SALGAN_PATH \
-save_dir checkpoint \
-model_name finetune_salicon \
-pretrain_path weights/salicon_salgan_pretrain.pth
```
Finetune FastSal C with pseudo saliency map generated by DeepGaze II and pretrained weights using COCO. In order to
train COCO dataset, pseudo labels has to be generated and saved at PSEUDO_PATH. In our example, we use Deepgaze II to 
generate pseudo saliency map. We save the probability saliency map with central bias in numpy data. We can provide the 
data upon request.
```bash
python fine_tune.py \
-model_type C \
-batch_size 30 \
-dataset_name coco \
-dataset_path DATASET_PATH \
-save_dir checkpoint \
-model_name finetune_coco \
-pretrain_path weights/coco_salgan_pretrain.pth \
-pseudo_path PSEUDO_PATH
```
#### Evaluation
Supports salicon or mit1003 for -dataset_name. 
If mit1003 is chosen for -dataset_name, -batch_size needs to be set 1.
Supports A or C for -model_type

Evaluation for SALICON 2017 validation set using FastSal A.
```bash
python eval.py \
-model_type A \
-batch_size 30 \
-dataset_name salicon \
-dataset_path DATASET_PATH \
-model_path weights/salicon_A.pth
```

#### To load FastSal in python
Examples of how to load FastSal is in simple_load.py
```python
model = fastsal.fastsal(pretrain_mode=False, model_type='A')
state_dict, opt_state = load_weight(MODEL_PATH, remove_decoder=False)
model.load_state_dict(state_dict)
```
## Future Development
Tensorflow implementation.

##Acknowledgement
This work has emanated from research conducted with the financial support of Science Foundation Ireland (SFI) 
under grant number SFI/15/SIRG/3283 and SFI/12/RC/2289 P2.